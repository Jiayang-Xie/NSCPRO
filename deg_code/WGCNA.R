###################### load the relevant packages################################
# install and load the relevant packages
options("repos" = c(CRAN="https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
BiocManager::install("factoextra")
BiocManager::install("FactoMineR")
BiocManager::install("hcluster")
BiocManager::install("tidyverse")
BiocManager::install("ggrepel")
BiocManager::install("VennDiagram")
BiocManager::install("ggVennDiagram")
BiocManager::install("ggvenn")
library(VennDiagram)
library(ggVennDiagram)
library(BiocManager)
library(DESeq2)
library(biomaRt)
library(curl)
library(pheatmap)
library(ggplot2)
library(GEOquery)
library("FactoMineR")
library("factoextra") 
library(RColorBrewer)
library(ggplot2)
library(tidyverse)
library(ggrepel)
library(ggvenn)
library(magrittr)
library(limma)
library(Mfuzz)
###################### load the data and construct the count matrix and design matrix#########
# input the rawcount files to build the matrix
p0_ctx1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/E15-5-P0A1_L3_307X07_sorted.count", sep="\t", col.names = c("gene_id","E15_p0_ctx1"))
p0_ctx2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/E15-5-P0A2_L3_308X08_sorted.count", sep="\t", col.names = c("gene_id","E15_p0_ctx2"))
p0_ge1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/E15-5-P0B1_L3_309X09_sorted.count", sep="\t", col.names = c("gene_id","E15_p0_ge1"))
p0_ge2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/E15-5-P0B2_L4_310X10_sorted.count", sep="\t", col.names = c("gene_id","E15_p0_ge2"))
p0_mid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/E15-5-P0C1_L4_310X10_sorted.count", sep="\t", col.names = c("gene_id","E15_p0_mid2"))
p0_mid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/E15-5-P0C2_L4_311X11_sorted.count", sep="\t", col.names = c("gene_id","E15_p0_mid1"))
p0_hid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/E15-5-P0D1_L4_312X12_sorted.count", sep="\t", col.names = c("gene_id","E15_p0_hid1"))
p0_hid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/E15-5-P0D2_L4_313X13_sorted.count", sep="\t", col.names = c("gene_id","E15_p0_hid2"))
p3_ctx3 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-CTX_L4_150A50_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_ctx3"))
p3_ctx2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-CTX2_L4_346X46_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_ctx2"))
p3_ctx1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-CTX1_L3_343X43_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_ctx1"))
p3_ge1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-GE1_L3_344X44_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_ge1"))
p3_ge2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-GE2_L4_347X47_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_ge2"))
p3_ge3 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-GE_L4_314X14_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_ge3"))
p3_mid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-MID1_L4_351X51_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_mid1"))
p3_mid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-MID2_L4_352X52_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_mid2"))
p3_mid3 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-MID_L4_152A52_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_mid3"))
p3_hid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-HID1_L3_345X45_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_hid1"))
p3_hid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-HID2_L3_349X49_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_hid2"))
p3_hid3 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P3-E15-5-HID_L4_153A53_sorted.count", sep="\t", col.names = c("gene_id","E15_p3_hid3"))
p6_ctx1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P6-E15-5-CTX1_L4_346X46_sorted.count", sep="\t", col.names = c("gene_id","E15_p6_ctx1"))
p6_ctx2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P6-E15-5-CTX2_L4_349X49_sorted.count", sep="\t", col.names = c("gene_id","E15_p6_ctx2"))
p6_ge1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P6-E15-5-GE1_L4_347X47_sorted.count", sep="\t", col.names = c("gene_id","E15_p6_ge1"))
p6_ge2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P6-E15-5-GE2_L4_350X50_sorted.count", sep="\t", col.names = c("gene_id","E15_p6_ge2"))
p6_hid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P6-E15-5-HID1_sorted.count", sep="\t", col.names = c("gene_id","E15_p6_hid1"))
p6_hid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P6-E15-5-hid_L4_379X79_sorted.count", sep="\t", col.names = c("gene_id","E15_p6_hid2"))
p6_mid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P6-E15-5-mid_L4_378X78_sorted.count", sep="\t", col.names = c("gene_id","E15_p6_mid1"))
p6_mid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E15_5/P6-E15-5-mid2.count", sep="\t", col.names = c("gene_id","E15_p6_mid2"))
###  E15
p0_ctx <- merge(p0_ctx1,p0_ctx2,by ="gene_id")
p3_ctx <-  merge(merge(p3_ctx1,p3_ctx2,by ="gene_id"),p3_ctx3,by ="gene_id")
p6_ctx <-merge(p6_ctx1,p6_ctx2,by ="gene_id")
p0_ge <- merge(p0_ge1,p0_ge2,by ="gene_id")
p3_ge <- merge(merge(p3_ge1,p3_ge2,by ="gene_id"),p3_ge3,by ="gene_id")
p6_ge <- merge(p6_ge1,p6_ge2,by ="gene_id")
p0_mid <- merge(p0_mid1,p0_mid2,by ="gene_id")
p3_mid <- merge(merge(p3_mid1,p3_mid2,by ="gene_id"),p3_mid3,by ="gene_id")
p6_mid <- merge(p6_mid1,p6_mid2,by ="gene_id")
p0_hid <- merge(p0_hid1,p0_hid2,by ="gene_id")
p3_hid <-  merge(merge(p3_hid1,p3_hid2,by ="gene_id"),p3_hid3,by ="gene_id")
p6_hid <-merge(p6_hid1,p6_hid2,by ="gene_id")
ctx <-merge(merge(p0_ctx,p3_ctx,by ="gene_id"),p6_ctx,by ="gene_id")
ge <-merge(merge(p0_ge,p3_ge,by ="gene_id"),p6_ge,by ="gene_id")
mid <-merge(merge(p0_mid,p3_mid,by ="gene_id"),p6_mid,by ="gene_id")
hid <-merge(merge(p0_hid,p3_hid,by ="gene_id"),p6_hid,by ="gene_id")
rawcount_E15 <-merge(merge(merge(ctx,ge,by ="gene_id"),mid,by ="gene_id"),hid,by ="gene_id")


p0_ctx1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/E13-5-P0A1_L4_311X11_sorted.count", sep="\t", col.names = c("gene_id","E13_p0_ctx1"))
p0_ctx2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/E13-5-P0A2_L4_312X12_sorted.count", sep="\t", col.names = c("gene_id","E13_p0_ctx2"))
p3_ctx1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P3-E13-5-CTX1_L3_350X50_sorted.count", sep="\t", col.names = c("gene_id","E13_p3_ctx1"))
p3_ctx2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P3-E13-5-CTX2_sorted.count", sep="\t", col.names = c("gene_id","E13_p3_ctx2"))
p6_ctx1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-CTX1_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_ctx1"))
p6_ctx2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-CTX2_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_ctx2"))
p6_ctx3 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-CTX_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_ctx3"))
p0_ge1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/E13-5-P0B1_L4_313X13_sorted.count", sep="\t", col.names = c("gene_id","E13_p0_ge1"))
p0_ge2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/E13-5-P0B2_L4_380X80_sorted.count", sep="\t", col.names = c("gene_id","E13_p0_ge2"))
p0_mid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/E13-5-P0C2_L4_382X82_sorted.count", sep="\t", col.names = c("gene_id","E13_p0_mid2"))
p0_mid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/E13-5-P0C1_L4_381X81_sorted.count", sep="\t", col.names = c("gene_id","E13_p0_mid1"))
p0_hid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/E13-5-P0D1_L4_314X14_sorted.count", sep="\t", col.names = c("gene_id","E13_p0_hid1"))
p0_hid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/E13-5-P0D2_L4_316X16_sorted.count", sep="\t", col.names = c("gene_id","E13_p0_hid2"))
p3_ge1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P3-E13-5-GE1_sorted.count", sep="\t", col.names = c("gene_id","E13_p3_ge1"))
p3_ge2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P3-E13-5-GE2_sorted.count", sep="\t", col.names = c("gene_id","E13_p3_ge2"))
p3_hid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P3-E13-5-HID1_sorted.count", sep="\t", col.names = c("gene_id","E13_p3_hid1"))
p3_hid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P3-E13-5-HID2_sorted.count", sep="\t", col.names = c("gene_id","E13_p3_hid2"))
p3_mid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P3-E13-5-MID1_sorted.count", sep="\t", col.names = c("gene_id","E13_p3_mid1"))
p3_mid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P3-E13-5-MID2_sorted.count", sep="\t", col.names = c("gene_id","E13_p3_mid2"))
p6_ge1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-GE1_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_ge1"))
p6_ge2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-GE2_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_ge2"))
p6_ge3 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-GE_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_ge3"))
p6_hid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-HID1_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_hid1"))
p6_hid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-HID2_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_hid2"))
p6_hid3 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-HID_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_hid3"))
p6_mid1 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-MID1_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_mid1"))
p6_mid2 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-MID2_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_mid2"))
p6_mid3 <- read.table("E:/yaner xuenian/NSCPRO/downstream/E13_5/P6-E13-5-MID_sorted.count", sep="\t", col.names = c("gene_id","E13_p6_mid3"))
###  E13
p0_ctx <- merge(p0_ctx1,p0_ctx2,by ="gene_id")
p6_ctx <-  merge(merge(p6_ctx1,p6_ctx2,by ="gene_id"),p6_ctx3,by ="gene_id")
p3_ctx <-merge(p3_ctx1,p3_ctx2,by ="gene_id")
p0_ge <- merge(p0_ge1,p0_ge2,by ="gene_id")
p6_ge <- merge(merge(p6_ge1,p6_ge2,by ="gene_id"),p6_ge3,by ="gene_id")
p3_ge <- merge(p3_ge1,p3_ge2,by ="gene_id")
p0_mid <- merge(p0_mid1,p0_mid2,by ="gene_id")
p6_mid <- merge(merge(p6_mid1,p6_mid2,by ="gene_id"),p6_mid3,by ="gene_id")
p3_mid <- merge(p3_mid1,p3_mid2,by ="gene_id")
p0_hid <- merge(p0_hid1,p0_hid2,by ="gene_id")
p6_hid <-  merge(merge(p6_hid1,p6_hid2,by ="gene_id"),p6_hid3,by ="gene_id")
p3_hid <-merge(p3_hid1,p3_hid2,by ="gene_id")
ctx <-merge(merge(p0_ctx,p3_ctx,by ="gene_id"),p6_ctx,by ="gene_id")
ge <-merge(merge(p0_ge,p3_ge,by ="gene_id"),p6_ge,by ="gene_id")
mid <-merge(merge(p0_mid,p3_mid,by ="gene_id"),p6_mid,by ="gene_id")
hid <-merge(merge(p0_hid,p3_hid,by ="gene_id"),p6_hid,by ="gene_id")
rawcount_E13 <-merge(merge(merge(ctx,ge,by ="gene_id"),mid,by ="gene_id"),hid,by ="gene_id")

rawcount_0 <- merge(rawcount_E13,rawcount_E15,by ="gene_id")
rawcount_1 <- rawcount_0[-c(1:5),]
ENSEMBL <- gsub("\\.\\d*", "",rawcount_1$gene_id)
row.names(rawcount_1) <-ENSEMBL
rawcount_2 <- rawcount_1[,-1]
rawcount_2 <- rawcount_2[,-c(7,14,19,28,33,40,47,54)]
rawcount_3 <- rawcount_2[apply(rawcount_2, 1, sum) > 24 , ] #remove the low express gene


#construct the coldata,3 bio replicates each group
condition <- factor(c(rep(c(rep(c("p0","p3","p6"),each= 2)),8)),levels = c("p0","p3","p6"))
tissue <- factor(c(rep(c(rep(c("ctx","ge","mid","hid"),each = 6)),2)),levels = c("ctx","ge","mid","hid"))
stage <- factor(c(rep(c("13","15"),each = 24)))
colData <- data.frame(row.names = colnames(rawcount_3),condition,tissue,stage)

E13_P0 =c(1,2,8,9,15,16,22,23)
E13_P3 =E13_P0+2
E13_P6 =c(5,6,12,13,20,21,26,27)
count_loop<- data.frame( E13_P0,E13_P3,E13_P6)
rawcount_cl <- rawcount_3[,E13_P3]
rawcount_log_cl <-log2(rawcount_cl+1)
colData_cl <- colData[E13_P3,c(2,2)]

dds <- DESeqDataSetFromMatrix(rawcount_3,colData,design = ~ stage+ condition + tissue  )
dds<- DESeq(dds)

normalized_counts <-counts(dds,normalized=T)
vstdata <-vst(dds,blind = FALSE)
vstdata_1 <- assay(vstdata)
vstdata_mad <- apply(vstdata_1, 1, mean)
vstdata_2 <- vstdata_1[order(vstdata_mad, decreasing=T), ]
vstdata_3 <- vstdata_2[1:5000, ]


vstdata_2 <- t(vstdata_1)

Time = c(rep(c(rep(c(1,1,3,3,6,6),4)),2))
ctx = c(rep(c(rep(1,6),rep(0,18)),2))
ge = c(rep(c(rep(0,6),rep(1,6),rep(0,12)),2))
mid = c(rep(c(rep(0,12),rep(1,6),rep(0,6)),2))
hid = c(rep(c(rep(0,18),rep(1,6)),2))
eday = c(rep(c(13,15),each = 24))
design<-cbind(Time,eday,ctx,ge,mid,hid)
rownames(design) <-colnames(vstdata_1)

write.table(vstdata_1,"wgcna_rnaseq_exp_1.txt",sep = " ",quote = F)
write.table(design,"wgcna_rnaseq_trait_1.txt",sep = " ",quote = F)
write.csv(vstdata_3,file ="wgcna_rnaseq_exp__5000_mean_2.csv")
write.csv(design,file = "wgcna_rnaseq_trait_1.csv")

